---
import AdminLayout from '../../layouts/AdminLayout.astro';
import StatCard from '../../components/StatCard.astro';

const API_BASE = import.meta.env.PUBLIC_API;

type ServiceStatus = {
  id: string;
  label: string;
  role: string;
  url?: string;
  ok: boolean | null;
};

const services: ServiceStatus[] = [
  { id: 'gs-web', label: 'Web (Pages)', role: 'Public site', url: 'https://goldshore.ai', ok: null },
  { id: 'gs-admin', label: 'Admin (Pages)', role: 'Control panel', url: 'https://admin.goldshore.ai', ok: null },
  { id: 'gs-api', label: 'API Worker', role: 'Core API', url: 'https://api.goldshore.ai', ok: true },
  { id: 'gs-gateway', label: 'Gateway Worker', role: 'Routing /api/*', url: 'https://gw.goldshore.ai', ok: null },
  { id: 'gs-control', label: 'Control Worker', role: 'Infra automation', url: 'https://ops.goldshore.ai', ok: null },
  { id: 'gs-mail', label: 'Mail Worker', role: 'Email routing', url: 'https://gs-mail.goldshore.workers.dev', ok: null }
];

let systemInfo: any = null;

try {
  const res = await fetch(`${API_BASE}/system/info`, { cache: 'no-store' });
  if (res.ok) systemInfo = await res.json();
} catch {}
---

<AdminLayout title="Systems">
  <section class="gs-systems-grid">
    {services.map((svc) => (
      <article class="gs-svc-card">
        <header>
          <h2>{svc.label}</h2>
          <span class={`gs-svc-pill ${svc.ok === false ? 'down' : svc.ok === true ? 'up' : 'unknown'}`}>
            {svc.ok === null ? 'Unknown' : svc.ok ? 'Online' : 'Offline'}
          </span>
        </header>
        <p class="gs-svc-role">{svc.role}</p>
        {svc.url && (
          <a href={svc.url} class="gs-svc-link" target="_blank" rel="noreferrer">
            {svc.url}
          </a>
        )}
      </article>
    ))}
  </section>

  <section class="gs-panel">
    <h2>Last API System Info</h2>
    <pre class="gs-json">
{JSON.stringify(systemInfo ?? { message: 'No data from gs-api /system/info yet.' }, null, 2)}
    </pre>
  </section>
</AdminLayout>

<style>
  .gs-systems-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    gap: 1rem;
    margin-bottom: 1.5rem;
  }

  .gs-svc-card {
    border-radius: 1rem;
    padding: 1rem 1.1rem;
    border: 1px solid rgba(148, 163, 184, 0.3);
    background: radial-gradient(circle at top, #020617, #000);
  }

  .gs-svc-card header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 0.75rem;
  }

  .gs-svc-card h2 {
    margin: 0;
    font-size: 0.95rem;
  }

  .gs-svc-role {
    margin: 0.4rem 0 0.6rem;
    font-size: 0.8rem;
    color: #9ca3af;
  }

  .gs-svc-link {
    font-size: 0.8rem;
    color: #22d3ee;
    text-decoration: none;
    word-break: break-all;
  }

  .gs-svc-pill {
    padding: 0.18rem 0.6rem;
    border-radius: 999px;
    font-size: 0.7rem;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    border: 1px solid rgba(148, 163, 184, 0.6);
  }

  .gs-svc-pill.up {
    border-color: #22c55e;
    color: #bbf7d0;
  }

  .gs-svc-pill.down {
    border-color: #ef4444;
    color: #fecaca;
  }

  .gs-svc-pill.unknown {
    color: #e5e7eb;
  }

  .gs-panel {
    border-radius: 1rem;
    padding: 1rem 1.25rem;
    border: 1px solid rgba(148, 163, 184, 0.25);
    background: rgba(15, 23, 42, 0.95);
  }

  .gs-json {
    margin: 0.75rem 0 0;
    font-size: 0.8rem;
    line-height: 1.4;
    max-height: 260px;
    overflow: auto;
  }
</style>
