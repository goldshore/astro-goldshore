---
const { method, path, openapi } = Astro.props;

const base = import.meta.env.PUBLIC_API || '';
const url = base + path;

let body = '';
let response = null;

async function send() {
  response = await fetch(url, {
    method: method.toUpperCase(),
    headers: { 'Content-Type': 'application/json' },
    body: body || undefined
  }).then(r => r.json()).catch(e => ({ error: e.message }));
}
---

<div class="try-box">
  <h4>Request</h4>
  <textarea oninput="body=this.value">{body}</textarea>

  <button onclick="send()">Send</button>

  <h4>Response</h4>
  <pre>{JSON.stringify(response, null, 2)}</pre>
</div>

<style>
  .try-box textarea {
    width: 100%;
    height: 140px;
    background: #020617;
    color: #e2e8f0;
    border: 1px solid rgba(148,163,184,0.4);
    border-radius: 0.5rem;
    padding: 0.75rem;
  }
</style>
<div class="try-console-js group relative mt-4 overflow-hidden rounded-xl border border-slate-700 bg-slate-900 font-mono text-sm" data-url={url} data-method={method}>
  <div class="flex items-center justify-between border-b border-slate-700 bg-slate-800 px-4 py-3">
    <div class="flex items-center gap-3 overflow-x-auto">
      <span class={`rounded px-2 py-1 text-xs font-bold uppercase text-white ${
        method === 'get' ? 'bg-sky-500' :
        method === 'post' ? 'bg-green-500' :
        method === 'put' ? 'bg-yellow-500' :
        method === 'delete' ? 'bg-red-500' :
        'bg-purple-500'
      }`}>{method}</span>
      <code class="text-slate-200">{path}</code>
    </div>
  </div>

  <div class="p-4">
    {method.toLowerCase() !== 'get' && method.toLowerCase() !== 'delete' && (
      <div class="mb-4">
        <label class="mb-2 block text-xs tracking-wide text-slate-400 uppercase">Request Body</label>
        <textarea
          class="body-input min-h-[100px] w-full rounded-lg border border-slate-700 bg-slate-950 p-3 text-slate-50 focus:border-sky-400 focus:outline-none focus:ring-1 focus:ring-sky-400"
          placeholder='{ "key": "value" }'
          spellcheck="false"
          aria-label="Request body JSON"
        ></textarea>
      </div>
    )}

    <div class="mb-4 flex items-center gap-4">
      <button class="send-btn inline-flex items-center gap-2 rounded-md bg-blue-600 px-4 py-2 font-medium text-white transition-colors hover:bg-blue-700 disabled:cursor-not-allowed disabled:bg-slate-600 disabled:opacity-70">
        <span class="btn-text">Send Request</span>
        <svg class="spinner h-4 w-4 animate-spin" viewBox="0 0 24 24" aria-hidden="true" hidden>
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
      </button>

      <div class="meta-info flex gap-3 text-sm" hidden aria-live="polite">
        <span class="status-badge rounded px-1.5 py-0.5 font-semibold"></span>
        <span class="time-badge text-slate-400"></span>
      </div>
    </div>

    <div class="response-area hidden rounded-lg border border-slate-700 bg-slate-950">
      <div class="flex items-center justify-between border-b border-slate-700 bg-slate-800/50 px-3 py-2">
        <span class="text-xs tracking-wide text-slate-400 uppercase">Response</span>
        <button class="copy-btn cursor-pointer bg-transparent text-xs text-slate-400 hover:text-slate-50" aria-label="Copy response">Copy</button>
      </div>
      <pre class="m-0 overflow-x-auto p-3 text-slate-200"><code class="response-code"></code></pre>
    </div>
  </div>
</div>

<script>
  function initConsole(el) {
    const url = el.dataset.url;
    const method = el.dataset.method;

    const sendBtn = el.querySelector('.send-btn');
    const btnText = el.querySelector('.btn-text');
    const spinner = el.querySelector('.spinner');

    const bodyInput = el.querySelector('.body-input');

    const metaInfo = el.querySelector('.meta-info');
    const statusBadge = el.querySelector('.status-badge');
    const timeBadge = el.querySelector('.time-badge');

    const responseArea = el.querySelector('.response-area');
    const responseCode = el.querySelector('.response-code');
    const copyBtn = el.querySelector('.copy-btn');

    async function handleSend() {
      // Reset state
      sendBtn.disabled = true;
      spinner.removeAttribute('hidden');
      btnText.textContent = 'Sending...';
      metaInfo.hidden = true;
      responseArea.classList.add('hidden');
      responseCode.textContent = '';

      const startTime = performance.now();
      let body = null;

      if (bodyInput && bodyInput.value.trim()) {
        try {
          body = JSON.stringify(JSON.parse(bodyInput.value));
        } catch (e) {
          alert('Invalid JSON in request body');
          sendBtn.disabled = false;
          spinner.setAttribute('hidden', '');
          btnText.textContent = 'Send Request';
          return;
        }
      }

      try {
        const res = await fetch(url, {
          method: method.toUpperCase(),
          headers: { 'Content-Type': 'application/json' },
          body: body
        });

        const endTime = performance.now();
        const duration = Math.round(endTime - startTime);

        // Process response
        let data;
        const contentType = res.headers.get('content-type');
        if (contentType && contentType.includes('application/json')) {
          data = await res.json();
        } else {
          data = await res.text();
        }

        // Update UI
        statusBadge.textContent = `${res.status} ${res.statusText}`;
        if (res.ok) {
            statusBadge.className = 'status-badge rounded px-1.5 py-0.5 font-semibold text-green-400 bg-green-400/10';
        } else {
            statusBadge.className = 'status-badge rounded px-1.5 py-0.5 font-semibold text-red-400 bg-red-400/10';
        }

        timeBadge.textContent = `${duration}ms`;
        metaInfo.hidden = false;

        responseCode.textContent = typeof data === 'string' ? data : JSON.stringify(data, null, 2);
        responseArea.classList.remove('hidden');

      } catch (err) {
        statusBadge.textContent = 'Network Error';
        statusBadge.className = 'status-badge rounded px-1.5 py-0.5 font-semibold text-red-400 bg-red-400/10';
        responseCode.textContent = err.message;
        metaInfo.hidden = false;
        responseArea.classList.remove('hidden');
      } finally {
        sendBtn.disabled = false;
        spinner.setAttribute('hidden', '');
        btnText.textContent = 'Send Request';
      }
    }

    sendBtn.addEventListener('click', handleSend);

    if (copyBtn) {
      copyBtn.addEventListener('click', () => {
        navigator.clipboard.writeText(responseCode.textContent);
        const original = copyBtn.textContent;
        copyBtn.textContent = 'Copied!';
        setTimeout(() => copyBtn.textContent = original, 2000);
      });
    }
  }

  // Initialize all instances
  document.querySelectorAll('.try-console-js').forEach(initConsole);
</script>
