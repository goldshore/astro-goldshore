---
let q = '';
let results = [];

// Note: In a real implementation, this would likely be a client-side component or use a framework specific way to handle state.
// Since this is an Astro component, the script below handles the client-side logic.
---

<div class="search-box" role="search">
  <input
    type="search"
    placeholder="Search docsâ€¦"
    id="docs-search-input"
    aria-label="Search documentation"
  />

  <div id="results" aria-live="polite">
  </div>
</div>

<script>
  const input = document.getElementById('docs-search-input');
  const resultsDiv = document.getElementById('results');

  // Optimization: Debounce function to prevent API calls on every keystroke
  function debounce(func, wait) {
    let timeout;
    return function(...args) {
      const context = this;
      clearTimeout(timeout);
      timeout = setTimeout(() => func.apply(context, args), wait);
    };
  }

  let searchController;

  async function runSearch(query) {
    // Abort previous request if it exists
    if (searchController) {
      searchController.abort();
    }
    searchController = new AbortController();
    const signal = searchController.signal;

    if (!query.trim()) {
      if(resultsDiv) {
        resultsDiv.textContent = '';
        resultsDiv.removeAttribute('aria-busy');
      }
      return;
    }

    if (resultsDiv) {
      // Show loading state
      const loading = document.createElement('div');
      loading.className = 'search-message';
      loading.style.padding = '0.5rem';
      loading.style.color = 'var(--gs-fg-muted, #888)';
      loading.textContent = 'Searching...';
      resultsDiv.textContent = '';
      resultsDiv.appendChild(loading);
      resultsDiv.setAttribute('aria-busy', 'true');
    }

    try {
      const res = await fetch('/api/docs-search?q=' + encodeURIComponent(query), { signal });
      if (!res.ok) {
        if (resultsDiv) {
          resultsDiv.textContent = '';
          resultsDiv.removeAttribute('aria-busy');
        }
        console.error(`Search request failed with status ${res.status}: ${res.statusText}`);
        return;
      }
      const results = await res.json();

      if (resultsDiv) {
        resultsDiv.textContent = ''; // Clear previous results
        resultsDiv.removeAttribute('aria-busy');

        if (results.length === 0) {
          const empty = document.createElement('div');
          empty.className = 'search-message';
          empty.style.padding = '0.5rem';
          empty.style.color = 'var(--gs-fg-muted, #888)';
          empty.textContent = 'No results found.';
          resultsDiv.appendChild(empty);
          return;
        }

        results.forEach((r) => {
            const a = document.createElement('a');
            // Sentinel: Basic protection against javascript: URIs
            if (r.url && !r.url.trim().toLowerCase().startsWith('javascript:')) {
                a.href = r.url;
            } else {
                a.href = '#';
                console.warn('Blocked potentially unsafe URL in search results');
            }
            a.textContent = r.title; // Sentinel: Prevent XSS by using textContent instead of innerHTML
            resultsDiv.appendChild(a);
        });
      }
    } catch (e) {
      if (e.name === 'AbortError') return; // Ignore aborted requests
      if (resultsDiv) {
        resultsDiv.textContent = '';
        resultsDiv.removeAttribute('aria-busy');
        const err = document.createElement('div');
        err.className = 'search-error';
        err.style.color = 'red';
        err.style.marginTop = '0.5em';
        err.textContent = 'Sorry, search failed. Please try again.';
        resultsDiv.appendChild(err);
      }
      console.error("Search failed", e);
    }
  }

  if (input) {
    // Wait 300ms after user stops typing before searching
    const debouncedSearch = debounce((e) => {
      runSearch((e.target as HTMLInputElement).value);
    }, 300);

    input.addEventListener('input', debouncedSearch);
  }
</script>
