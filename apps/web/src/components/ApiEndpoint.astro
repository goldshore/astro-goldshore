---
import ApiSchema from './ApiSchema.astro';
import TryItConsole from './TryItConsole.astro';

const { openapi, endpointId, endpoint } = Astro.props;

// Support both props for compatibility
const targetEndpoint = endpointId || endpoint;
// If endpoint is passed as relative path e.g. "users", we might need to find /users or /api/v1/users
// But based on previous file, it seems it expects endpointId to be the key in openapi.paths stripped of leading slash?

// Let's look for a match
const match = Object.entries(openapi.paths || {})
  .find(([p]) => p.replace(/^\//,'') === targetEndpoint || p === targetEndpoint || p === '/' + targetEndpoint);

// If no match, and we are just rendering a placeholder (previous implementation had simple dump)
// But we want to fix the build error which is duplicate code block.

const [path, ops] = match || [targetEndpoint, null];

const methods = ['get','post','put','delete','patch'];
---

{match ? (
<section class="api-endpoint">
  <h1>{path}</h1>

  {methods.map((m) => (
    ops[m] && (
      <article class="method-block">
        <h2>{m.toUpperCase()}</h2>
        <p>{ops[m].description}</p>

        <h3>Parameters</h3>
        <ApiSchema schema={ops[m].parameters} />

        <h3>Request Body</h3>
        {ops[m].requestBody && (
          <ApiSchema schema={ops[m].requestBody.content} />
        )}

        <h3>Responses</h3>
        <ApiSchema schema={ops[m].responses} />

        <h3>Try It</h3>
        <TryItConsole
          method={m}
          path={path}
          openapi={openapi}
        />
      </article>
    )
  ))}
</section>
) : (
<div class="endpoint">
  <h2>{targetEndpoint}</h2>
  <p>Endpoint not found.</p>
</div>
)}

<style>
  .endpoint { padding: 2rem; }
  .method-block {
    margin-bottom: 2.5rem;
    padding: 1.5rem;
    border-radius: 1rem;
    background: rgba(15,23,42,0.8);
    border: 1px solid rgba(148,163,184,0.3);
  }
</style>
