---
import ApiSchema from './ApiSchema.astro';
import TryItConsole from './TryItConsole.astro';

const { openapi, endpoint } = Astro.props;

// endpoint comes from slug, e.g. "users" or "users/123"
// openapi paths usually start with /, e.g. "/users"

const lookupPath = endpoint.startsWith('/') ? endpoint : '/' + endpoint;

const match = Object.entries(openapi.paths || {})
  .find(([p]) => p === lookupPath || p === endpoint);

const [path, ops] = match || [null, null];

const methods = ['get','post','put','delete','patch'];
---

<section class="api-endpoint">
  {path ? (
      <>
      <h1 class="text-2xl font-bold mb-6 text-[var(--gs-text-primary)]">{path}</h1>
      {methods.map((m) => (
        ops[m] && (
          <article class="method-block mb-10 p-6 rounded-xl bg-[var(--gs-surface)] border border-[var(--gs-border)]">
            <div class="flex items-center gap-4 mb-4">
                <span class="uppercase font-mono font-bold text-[var(--gs-brand-blue)]">{m}</span>
                <p class="text-[var(--gs-text-secondary)]">{ops[m].summary || ops[m].description}</p>
            </div>

            {ops[m].parameters && (
                <div class="mb-4">
                    <h3 class="text-sm font-bold uppercase text-[var(--gs-text-secondary)] mb-2">Parameters</h3>
                    <ApiSchema schema={ops[m].parameters} />
                </div>
            )}

            {ops[m].requestBody && ops[m].requestBody.content && (
                <div class="mb-4">
                    <h3 class="text-sm font-bold uppercase text-[var(--gs-text-secondary)] mb-2">Request Body</h3>
                    <ApiSchema schema={ops[m].requestBody.content} />
                </div>
            )}

            {ops[m].responses && (
                <div class="mb-4">
                    <h3 class="text-sm font-bold uppercase text-[var(--gs-text-secondary)] mb-2">Responses</h3>
                    <ApiSchema schema={ops[m].responses} />
                </div>
            )}

            <div class="mt-6 pt-4 border-t border-[var(--gs-border)]">
                <h3 class="text-sm font-bold uppercase text-[var(--gs-text-secondary)] mb-2">Try It</h3>
                <TryItConsole
                method={m}
                path={path}
                openapi={openapi}
                />
            </div>
          </article>
        )
      ))}
      </>
  ) : (
      <div class="p-4 text-[var(--gs-text-secondary)]">
        {endpoint ? `Endpoint not found: ${endpoint}` : 'Select an endpoint from the sidebar.'}
      </div>
  )}
</section>
