name: Jules AutoFix (Conflicts, Lockfiles, Drift)

on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:
    inputs:
      pr:
        description: 'Pull Request number to clean'
        required: true

jobs:
  autofix:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: write

    steps:
      - name: Get PR Data
        id: pr_data
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            PR_NUMBER=${{ github.event.pull_request.number }}
            BRANCH_NAME=${{ github.event.pull_request.head.ref }}
          else
            PR_NUMBER=${{ github.event.inputs.pr }}
            BRANCH_NAME=$(gh pr view $PR_NUMBER --json headRefName --jq '.headRefName')
          fi
          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT

      - name: Checkout branch
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
        with:
          ref: ${{ steps.pr_data.outputs.branch_name }}
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name 'Jules AutoFix Bot'
          git config user.email 'jules-bot@users.noreply.github.com'

      - name: Sync with main branch
        id: sync
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git fetch origin main

          if git rebase origin/main; then
            echo "âœ… Branch rebased cleanly onto main."
            echo "status=rebased" >> $GITHUB_OUTPUT
            git push --force
            exit 0
          fi

          echo "âš ï¸ Rebase failed. Analyzing conflicts..."
          CONFLICTED_FILES=$(git diff --name-only --diff-filter=U)
          NORMALIZED_FILES=$(echo "$CONFLICTED_FILES" | tr ' ' '\n' | sort | uniq)

          git rebase --abort

          if [ "$NORMALIZED_FILES" == "pnpm-lock.yaml" ]; then
            echo "âœ… Conflict is only in pnpm-lock.yaml. Proceeding with merge fix."
            echo "status=merge_fix" >> $GITHUB_OUTPUT
          else
            echo "âŒ Unresolvable conflicts detected in files other than the lockfile."
            echo "$CONFLICTED_FILES"
            echo "status=unresolvable" >> $GITHUB_OUTPUT
            gh pr comment ${{ steps.pr_data.outputs.pr_number }} --body "ğŸš¨ **Jules AutoFix:** Cannot automatically resolve conflicts. Manual intervention is needed for the following files: \`\`\`$CONFLICTED_FILES\`\`\`"
            exit 1
          fi

      - name: Resolve by Merging and Regenerating Lockfile
        if: steps.sync.outputs.status == 'merge_fix'
        run: |
          echo "ğŸ”„ Merging 'main' into the branch..."
          git merge origin/main --commit --no-edit -m "Jules AutoFix: Merge main to resolve lockfile conflict"

          echo "ğŸ§¹ Removing old lockfile and node_modules."
          rm -f pnpm-lock.yaml
          rm -rf node_modules

          echo "ğŸ“¦ Reinstalling dependencies to generate a new lockfile..."
          npm install -g pnpm
          pnpm install

          echo "ğŸ“ Committing the regenerated lockfile."
          git add pnpm-lock.yaml
          git commit -m "Jules AutoFix: Regenerate lockfile after merging main"

          echo "ğŸš€ Pushing the fix..."
          git push

      - name: Comment on PR after Fix
        uses: marocchino/sticky-pull-request-comment@773744901bac0e8cbb5a0dc842800d45e9b2b405
        if: steps.sync.outputs.status == 'merge_fix'
        with:
          header: Jules AutoFix
          message: |
            âœ” Branch synced with \`main\` by merging.
            âœ” Lockfile regenerated to resolve conflicts.
            âœ” CI checks re-started.
